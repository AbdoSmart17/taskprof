        // Curriculum Data
        const curriculumData = {
            'الأولى': {
                'الإنسان والصحة': {
                    "التغذية عند الانسان": ["مصدر الأغذية", "تركيب الأغذية (تحليل تركيب الحليب)", "تركيب الأغذية (تحليل تركيب أغذية أخرى)", "دور الأغذية في الجسم", "الحاجيات الغذائية للعضوية", "الراتب الغذائي", "التوازن الغذائي (عواقب سوء التغذية)", "وضعية تعلم ادماج الموارد"],
                    "التحصل على الطاقة عند الانسان": ["المبادلات الغازية التنفسية عند الانسان", "المعنى البيولوجي للتنفس", "القواعد الصحية للتنفس", "وضعية تعلم ادماج الموارد"],
                    "الاطراح وثبات توازن الوسط الداخلي": ["تعريف الاطراح عند الانسان", "دور أعضاء الاطراح", "القواعد الصحية للاطراح", "وضعية تعلم ادماج الموارد"],
                    "التكاثر الجنسي عند الانسان": ["الأجهزة التكاثرية عند الانسان", "الالقاح وشروطه", "القواعد الصحية للتكاثر", "وضعية تعلم ادماج الموارد"],
                    "الخلية": ["مفهوم الخلية", "المجهر الضوئي", "الخلية الحيوانية"]
                },
                'الإنسان والمحيط': {
                    "التغذية عند النبات الأخضر": ["الحاجيات الغذائية للنبات الأخضر", "تأثير تركيز المحلول المعدني على نمو النبات", "مقر امتصاص المحلول المعدني", "المبادلات الغازية اليخضورية ومقرها", "التركيب الضوئي وشروطه", "أهمية التحكم في شروط التركيب الضوئي", "مسار النسغ الخام في النبات الأخضر", "دور النتح في انتقال النسغ /مصير النسغ", "وضعية تعلم ادماج الموارد"],
                    "التحصل على الطاقة عند النبات الأخضر": ["المبادلات الغازية التنفسية عند النبات الأخضر", "مقر المبادلات الغازية التنفسية عند النبات الأخضر", "المعنى البيولوجي للتنفس عند النبات", "اشكال أخرى للتحصل على الطاقة (التخمر)", "وضعية تعلم ادماج الموارد"],
                    "التكاثر الجنسي عند النباتات الزهرية": ["الأجهزة التكاثرية عند النبات الزهري", "الالقاح وشروطه", "وضعية تعلم ادماج الموارد"],
                    "الخلية النباتية": ["مفهوم الخلية", "المجهر الضوئي", "الخلية النباتية"]
                }
            },
            'الثانية': {
                'الإنسان والمحيط': {
                    "الوسط الحي": ["خصائص الوسط الحي", "العلاقات القائمة بين العناصر الحية في الوسط الحي", "تأثير العوامل الفيزيوكيميائية على توزع الكائنات الحية ونشاطها", "النظام البيئي وشروط توازنه", "دور الانسان في استقرار النظام البيئي", "وضعية تعلم ادماج الموارد"],
                    "توزّع الكائنات الحية في أوساطها": ["مظاهر تكيف النباتات مع اوساطها", "تنفس الحيوانات واحتلال الأوساط", "تأثير الانسان على التوزع الطبيعي للحيوانات", "العلاقة بين وسط حياة حيوان ونمط تنقله", "وضعية تعلم ادماج الموارد"],
                    "التكاثر وإعمار الأوساط": ["أنماط التكاثر عند الحيوان", "أنماط التكاثر عند النباتات", "تأثير الإنسان على إعمار الأوساط", "وضعية تعلم ادماج الموارد"],
                    "تصنيف الكائنـــات الحيــــة": ["مفهوم النوع عند الكائنات الحية", "استخدام معايير التصنيف", "وضعية تعلم ادماج الموارد"],
                    "المستحاثات": ["المستحاثات وشروط الاستحاثة", "مكانة المستحاثات في تصور الأوساط القديمة", "وضعية تعلم ادماج الموارد"],
                }
            },
            'الثالثة': {
                "الإنسان والمحيط (الديناميكية الداخلية للكرة الارضية)": {
                    "الزلازل": ["مظاهر وعواقب زلزال", "خصائص الزلزال", "النشاط الزلزالي لشمال افريقيا"],
                    "أسباب الزلازل": ["الربط بين حدوث الزلزال وتشكل الجبال (الطيات والفوالق)", "اختبار فرضية مصدر الزلزال"],
                    "نشاط الظهرات ": ["الشواهد الدالة على زحزحة القارات", "ابراز العلاقة بين زحزحة القارات والظهرات", "تفسير زحزحة القارات بنشاط الظهرات (أنماط ص تكتونية/ تيارات الحمل)"],
                    "الغوص والظواهر الجيولوجية المرتبطة به ": ["بناء مفهوم الغوص (الية حركة تقارب الصفائح التكتونية)", "الظواهر الجيولوجية المرتبطة بالغوص ( البركنة المرتبطة بالغوص /جبال الهيمالايا )"],
                    "التكتونية العامة و البنية الداخلية للكرة الأرضية": ["الاليات التفسيرية لاهم الظواهر الجيولوجية (تغير سرعة انتشار الأمواج الزلزالية)", "وصف البنية الداخلية للكرة الأرضية"],
                    "التكتونية في حوض البحر المتوسط ": ["تفسير الظواهر الجيولوجية في حوض البحر المتوسط (سلسلة جبال الاطلس)", "النشاط الزلزالي والبركاني في إيطاليا"],
                    "الإجراءات الوقائية والتنبئية المتعلقة بالظواهر الجيولوجية": ["التقيد بالإجراءات الوقائية (انجاز بحث حول الاحتياطات الواجب اتخاذها)", "وضعية تعلم ادماج الموارد"],
                },
                " الانسان والمحيط (الديناميكية الخارجية للكرة الأرضية) ": {
                    " البنيات الجيولوجية الكبرى وخصائصها": ["تمييز المركبات الكبرى للمناظر الطبيعية", "تفسير اصل الاختلافات الملاحظة بين المناظر الطبيعية (مكاشف الصخور)"],
                    "تشكل المنظر الطبيعي وطبيعة الصخور ": ["إحصاء أنواع الصخور المشكلة للمناظر الطبيعية في الجزائر", "الخواص الفيزيوكيميائية للصخور (تحديد خاصيتين فيزيوكيميائيتين)", "الربط بين خواص الصخور وتشكل المنظر الطبيعي"],
                    " أثر العوامل المناخية في تغير المنظر الطبيعي ": ["آليات التأثير الفيزيوكيميائي للعوامل المناخية على الصخور (الماء / الرياح / الحرارة )", "التعرف على ملامح تغير تضاريس المنظر الطبيعي"],
                    " تطور شكل المنظر الطبيعي": ["التدخلات السلبية والايجابية للإنسان على تطور منظر طبيعي", "تطور منظر طبيعي عبر الزمن الجيولوجي (الى الشكل الحالي )", "وضعية تعلم ادماج الموارد"],
                },
                "الانسان والمحيط ( استغلال الموارد الطبيعية الباطنية)": {
                    "الثروات الطبيعية الباطنية في الجزائر": ["التعرف على اهم الموارد الطبيعية الباطنية في الجزائر"],
                    "مميزات الموارد الطبيعية في الجزائر": ["خواص البترول ومراحل تشكله / تحديد مواضع تواجد الماء"],
                    "استغلال الموارد الطبيعية ": ["كيفية استغلال الموارد الباطنية (البترول والماء )", "ابراز ضرورة الاستغلال العقلاني للموارد الباطنية", "وضعية تعلم ادماج الموارد"],
                },
                "الانسان والمحيط (التربة ثروة طبيعية هشة)": {
                    " التربة وسط حي ": ["التعرف على التربة", "العلاقة بين بنية التربة ومكوناتها الحية", "الطابع الهش للتربة"],
                    " تشكل التربة ": ["منشأ التربة", "مراحل تشكل التربة"],
                    " حماية التربة " : ["التدخل السلبي والايجابي للإنسان على التربة الزراعية", "وضعية تعلم ادماج الموارد", "وقفة تقييمية (الفرض )"],
                }
            },
            'الرابعة': {
                "الانسان والصحة (التغذية عند الانسان)": {
                    "تحويل الأغذية خلال الهضم": ["تشخيص المكتسبات (الوضعية الانطلاقية الشاملة)", "ابراز التحولات التي تطرا على مكونات غذاء (الخبز) في مختلف مستويات الانبوب الهضمي", "بناء مفهوم الهضم ( التأثير النوعي للإنزيم)", "المعنى البيولوجي للهضم"],
                    "امتصاص المغذيات": ["مصير الأغذية المهضومة", "مميزات مقر امتصاص المغذيات"],
                    "نقل المغذيات": ["ابين دور الدم", "الفرض 1", "مسار نقل المغذيات والغازات"],
                    "استعمال المغذيات": ["استعمال غاز الاكسجين والمغذيات في نسيج حي", "تصحيح الفرض", "التنفس الخلوي عند خميرة الخبز", "دور المغذيات في الجسم"],
                    "التوازن الغذائي": ["عواقب التغذية الغير صحية (حل وضعيات ادماج لمختلف الاختلالات المتعلقة بالتغذية )", "حصة ادماج كلي للمقطع 01"],
                },
                " الانسان والصحة (التنسيق الوظيفي في العضوية)": {
                    "الارتباط التشريحي للاتصال العصبي": ["اتعرف على البنيات المتخصصة في استقبال التنبيهات", "اظهر الدعامة البنيوية للاتصال العصبي", "احدد مظهر الرسائل وطرائق انتقالها"],
                    "الحركة الارادية والفعل الحركي اللاإرادي": ["احلل حركة ارادية", "اميز خصوصيات الحركة اللاإرادية"],
                    "اختلال الاتصال العصبي": ["ابين تأثير مختلف المواد المخدرة وعواقبها", "حل الوضعية الانطلاقية (معالجة بيداغوجية)"],
                    "الحواجز الطبيعية والاجسام الغريبة": ["الحواجز الطبيعية التي تستعملها العضوية من اجل الحماية"],
                    "الاستجابة المناعية اللانوعية": ["اظهر مميزات الخط الدفاعي الثاني للعضوية"],
                    "الاستجابة المناعية النوعية": ["اشرح الية الخط الدفاعي الثالث للعضوية"],
                    "الذات و اللاذات": ["ابين قدرة العضوية على تمييز الذات عن اللاذات", "وقفة تقييمية"],
                    "الاعتلالات المناعية": ["اتعرف على حالة اعتلال مناعي (الحساسية)", "اشرح مبدا العون المناعي", "حصة ادماج كلي للمقطع 02"],
                },
                "الانسان و الصحة (انتقال الصفات الوراثية)": {
                    "تشكل الامشاج والالقاح": ["طرح الوضعية الانطلاقية", "اصف مراحل تشكل الامشاج الذكريه والانثوية", "احلل سلوك الصبغيات اثناء تشكل الامشاج لتعريف النمط النووي", "ابين دور الالقاح في ضمان استمرارية النوع"],
                    "دعامة انتقال الصفات الوراثية": ["اقارن بين صفات مجموعة من الافراد", "ابين مقر المعلومة الوراثية"],
                    "الاختلالات الوراثية": ["أتعرف على بعض الاختلالات الكروموزومية", "احدد اسباب بعض الامراض الوراثية", "أحدد معنى الطفرة الوراثية", "أبين خطورة الزواج بين ذوي الأقارب", "حل الوضعية الانطلاقية - معالجة بيداغوجية محتملة", "الفرض الاخير - تصحيح الفرض", "حل الوضعية الشاملة"],
                }
            }
        };

        // App State
        let schedule = JSON.parse(localStorage.getItem('schedule')) || [];
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let currentTaskFilter = 'all'; // 'all', 'pending', 'completed'

        // DOM Elements
        const scheduleForm = document.getElementById('schedule-form');
        const taskForm = document.getElementById('task-form');
        const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
        const scheduleTableBody = document.querySelector('#schedule-table tbody');
        const tasksListDiv = document.getElementById('tasks-list');
        const showAllTasksBtn = document.getElementById('show-all-tasks');
        const showPendingTasksBtn = document.getElementById('show-pending-tasks');
        const showCompletedTasksBtn = document.getElementById('show-completed-tasks');
        const notificationSound = document.getElementById('notification-sound');
        const alertContainer = document.querySelector('.alert-container');
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('task-date').value = today;
            
            // Load initial data
            renderScheduleTable();
            renderTasksList();
            
            // Setup event listeners
            setupEventListeners();
            
            // Schedule notifications
            scheduleNotifications();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Schedule form submission
            scheduleForm.addEventListener('submit', handleScheduleSubmit);
            
            // Task form submission
            taskForm.addEventListener('submit', handleTaskSubmit);
            
            // Notification button
            enableNotificationsBtn.addEventListener('click', enableNotifications);
            
            // Task filter buttons
            showAllTasksBtn.addEventListener('click', () => {
                currentTaskFilter = 'all';
                updateActiveFilterButton('all');
                renderTasksList();
            });
            
            showPendingTasksBtn.addEventListener('click', () => {
                currentTaskFilter = 'pending';
                updateActiveFilterButton('pending');
                renderTasksList();
            });
            
            showCompletedTasksBtn.addEventListener('click', () => {
                currentTaskFilter = 'completed';
                updateActiveFilterButton('completed');
                renderTasksList();
            });
            
            // Date change event
            document.getElementById('task-date').addEventListener('change', function() {
                const selectedDate = this.value;
                const today = new Date().toISOString().split('T')[0];
                
                if (selectedDate < today) {
                    showAlert('لقد حددت تاريخاً قديماً! يرجى اختيار تاريخ اليوم أو تاريخ مستقبلي.', 'warning');
                }
                
                // Update class select
                updateClassSelect(selectedDate);
            });
            
            // Class select change
            document.getElementById('task-class-select').addEventListener('change', function() {
                const selectedClass = this.value;
                if (selectedClass) {
                    const level = selectedClass.split(' ')[0];
                    populateFieldSelect(level);
                }
            });
            
            // Field select change
            document.getElementById('task-field-select').addEventListener('change', function() {
                const selectedClass = document.getElementById('task-class-select').value;
                const level = selectedClass.split(' ')[0];
                const field = this.value;
                populateModuleSelect(level, field);
            });
            
            // Module select change
            document.getElementById('task-module-select').addEventListener('change', function() {
                const selectedClass = document.getElementById('task-class-select').value;
                const level = selectedClass.split(' ')[0];
                const field = document.getElementById('task-field-select').value;
                const module = this.value;
                populateActivitySelect(level, field, module);
            });
        }
        
        // Handle Schedule Form Submission
        function handleScheduleSubmit(e) {
            e.preventDefault();
            
            const newScheduleItem = {
                id: Date.now(),
                day: document.getElementById('schedule-day').value,
                startTime: document.getElementById('schedule-start-time').value,
                endTime: document.getElementById('schedule-end-time').value,
                level: document.getElementById('schedule-level-select').value,
                classNumber: document.getElementById('schedule-class-number').value
            };
            
            schedule.push(newScheduleItem);
            saveSchedule();
            renderScheduleTable();
            scheduleForm.reset();
            
            showAlert('تم إضافة الحصة بنجاح!', 'success');
        }
        
        // Handle Task Form Submission
        function handleTaskSubmit(e) {
            e.preventDefault();
            
            const selectedDate = document.getElementById('task-date').value;
            const today = new Date().toISOString().split('T')[0];
            
            // Validate date
            if (selectedDate < today) {
                showAlert('لا يمكن إضافة مهمة لتاريخ مضى!', 'danger');
                return;
            }
            
            const selectedClass = document.getElementById('task-class-select').value;
            if (!selectedClass) {
                showAlert('يرجى اختيار قسم صحيح', 'danger');
                return;
            }
            
            const [level, classNumber] = selectedClass.split(' ');
            
            const newTask = {
                id: Date.now(),
                text: document.getElementById('task-text').value,
                date: selectedDate,
                notificationDuration: parseInt(document.getElementById('task-notification-duration').value) || 0,
                alertType: document.getElementById('task-alert-type').value,
                level: level,
                classNumber: classNumber,
                field: document.getElementById('task-field-select').value,
                module: document.getElementById('task-module-select').value,
                activity: document.getElementById('task-activity-select').value,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(newTask);
            saveTasks();
            renderTasksList();
            scheduleNotifications();
            taskForm.reset();
            
            // Reset selects
            document.getElementById('task-class-select').innerHTML = '<option value="">اختر قسم (بعد اختيار التاريخ)</option>';
            document.getElementById('task-field-select').innerHTML = '<option value="">اختر ميدان</option>';
            document.getElementById('task-module-select').innerHTML = '<option value="">اختر مقطع</option>';
            document.getElementById('task-activity-select').innerHTML = '<option value="">اختر نشاط</option>';
            
            showAlert('تم إضافة المهمة بنجاح!', 'success');
        }
        
        // Enable Notifications
        function enableNotifications() {
            if (!('Notification' in window)) {
                showAlert('المتصفح لا يدعم الإشعارات!', 'danger');
                return;
            }
            
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showAlert('تم تفعيل التنبيهات بنجاح! سيتم إعلامك بالمهام في المواعيد المحددة.', 'success');
                    enableNotificationsBtn.innerHTML = '<i class="fas fa-bell me-1"></i> التنبيهات مفعلة';
                    enableNotificationsBtn.classList.remove('btn-outline-primary');
                    enableNotificationsBtn.classList.add('btn-success');
                    
                    // Test notification
                    if (Notification.permission === 'granted') {
                        new Notification('اختبار الإشعارات', {
                            body: 'هذا إشعار اختبار للتأكد من عمل النظام',
                            icon: 'icon-192.png',
                            dir: 'rtl'
                        });
                        
                        // Play notification sound
                        if (notificationSound) {
                            notificationSound.currentTime = 0;
                            notificationSound.play().catch(e => console.log('تعذر تشغيل الصوت: ', e));
                        }
                    }
                }
            });
        }
        
        // Save Schedule to LocalStorage
        function saveSchedule() {
            localStorage.setItem('schedule', JSON.stringify(schedule));
        }
        
        // Save Tasks to LocalStorage
        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        // Render Schedule Table
        function renderScheduleTable() {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
            scheduleTableBody.innerHTML = '';
            
            // Collect all unique start times
            const allStartTimes = [...new Set(schedule.map(item => item.startTime))].sort();
            
            if (allStartTimes.length === 0) {
                scheduleTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                            <p>لم يتم إضافة حصص بعد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allStartTimes.forEach(time => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.textContent = time;
                row.appendChild(timeCell);
                
                days.forEach(day => {
                    const dayCell = document.createElement('td');
                    const matchingItems = schedule.filter(item => item.day === day && item.startTime === time);
                    
                    if (matchingItems.length > 0) {
                        matchingItems.forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'schedule-item-cell';
                            itemDiv.innerHTML = `
                                <p class="mb-1 fw-bold">${item.level} ${item.classNumber}</p>
                                <p class="mb-0">${item.startTime} - ${item.endTime}</p>
                                <button class="btn btn-sm btn-link text-danger p-0 mt-1" 
                                        onclick="deleteScheduleItem(${item.id})">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                            dayCell.appendChild(itemDiv);
                        });
                    }
                    
                    row.appendChild(dayCell);
                });
                
                scheduleTableBody.appendChild(row);
            });
        }
        
        // Delete Schedule Item
        function deleteScheduleItem(id) {
            schedule = schedule.filter(item => item.id !== id);
            saveSchedule();
            renderScheduleTable();
            showAlert('تم حذف الحصة بنجاح', 'success');
        }
        
        // Render Tasks List
        function renderTasksList() {
            const filteredTasks = tasks.filter(task => {
                if (currentTaskFilter === 'pending') return !task.completed;
                if (currentTaskFilter === 'completed') return task.completed;
                return true;
            });
            
            if (filteredTasks.length === 0) {
                tasksListDiv.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">لا توجد مهام ${getFilterText(currentTaskFilter)}</h5>
                        <p class="text-muted">قم بإضافة مهمة جديدة لبدء الاستخدام</p>
                    </div>
                `;
                return;
            }
            
            tasksListDiv.innerHTML = '';
            
            filteredTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `alert ${task.completed ? 'alert-success' : 'alert-primary'} 
                                      d-flex justify-content-between align-items-center mb-3 p-3 
                                      task-item ${task.completed ? 'task-completed' : ''} 
                                      ${isTaskUrgent(task) ? 'task-urgent' : ''}`;
                
                taskItem.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-bell me-2"></i>
                                ${task.alertType}
                            </h5>
                            ${getTaskBadge(task)}
                        </div>
                        <p class="mb-1">
                            <i class="fas fa-calendar-day me-2"></i> 
                            تاريخ الحصة: ${task.date}
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-clock me-2"></i> 
                            التنبيه قبل الموعد بـ: ${task.notificationDuration} دقيقة
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-graduation-cap me-2"></i> 
                            ${task.level} متوسط - القسم ${task.classNumber}
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-book me-2"></i> 
                            الميدان: ${task.field}
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-layer-group me-2"></i> 
                            المقطع: ${task.module}
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-sticky-note me-2"></i> 
                            النشاط: ${task.activity}
                        </p>
                        ${task.text ? `<p class="mt-2"><strong>ملاحظات:</strong> ${task.text}</p>` : ''}
                    </div>
                    <div class="d-flex flex-column ms-3">
                        <button class="btn ${task.completed ? 'btn-outline-success' : 'btn-success'} btn-sm mb-2"
                                onclick="toggleTaskCompletion(${task.id})">
                            <i class="fas ${task.completed ? 'fa-undo' : 'fa-check'}"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                tasksListDiv.appendChild(taskItem);
            });
        }
        
        // Toggle Task Completion
        function toggleTaskCompletion(id) {
            tasks = tasks.map(task => {
                if (task.id === id) {
                    return {...task, completed: !task.completed};
                }
                return task;
            });
            
            saveTasks();
            renderTasksList();
            scheduleNotifications();
            
            const task = tasks.find(t => t.id === id);
            const message = task.completed ? 'تم تحديد المهمة كمكتملة' : 'تم إعادة فتح المهمة';
            showAlert(message, 'success');
        }
        
        // Delete Task
        function deleteTask(id) {
            if (confirm('هل أنت متأكد من حذف هذه المهمة؟')) {
                tasks = tasks.filter(task => task.id !== id);
                saveTasks();
                renderTasksList();
                scheduleNotifications();
                showAlert('تم حذف المهمة بنجاح', 'success');
            }
        }
        
        // Schedule Notifications
        function scheduleNotifications() {
            tasks.forEach(task => {
                if (!task.completed && Notification.permission === 'granted') {
                    const classSchedule = schedule.find(item => 
                        item.day === getDayFromDate(task.date) && 
                        item.level === task.level && 
                        item.classNumber === task.classNumber
                    );
                    
                    if (classSchedule) {
                        const [taskYear, taskMonth, taskDay] = task.date.split('-');
                        const [classHour, classMinute] = classSchedule.startTime.split(':');
                        
                        const classStartTime = new Date(taskYear, taskMonth - 1, taskDay, classHour, classMinute);
                        const notificationDurationMs = task.notificationDuration * 60 * 1000;
                        const notificationTime = new Date(classStartTime.getTime() - notificationDurationMs);
                        const now = new Date();
                        const timeDiff = notificationTime.getTime() - now.getTime();
                        
                        if (timeDiff > 0) {
                            setTimeout(() => {
                                if (Notification.permission === 'granted') {
                                    new Notification(`تنبيه: ${task.alertType}`, {
                                        body: `لديك مهمة: ${task.text} مع قسم ${task.level} ${task.classNumber}`,
                                        icon: 'icon-192.png',
                                        dir: 'rtl'
                                    });
                                    
                                    if (notificationSound) {
                                        notificationSound.currentTime = 0;
                                        notificationSound.play();
                                    }
                                }
                            }, timeDiff);
                        }
                    }
                }
            });
        }
        
        // Helper Functions
        function getDayFromDate(dateString) {
            const date = new Date(dateString.replace(/-/g, '/'));
            const daysOfWeekArabic = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            return daysOfWeekArabic[date.getDay()];
        }
        
        function isTaskUrgent(task) {
            const now = new Date();
            const taskDate = new Date(task.date);
            const diffDays = Math.floor((taskDate - now) / (1000 * 60 * 60 * 24));
            return diffDays <= 1;
        }
        
        function getTaskBadge(task) {
            if (task.completed) {
                return '<span class="badge bg-success">مكتملة</span>';
            } else if (isTaskUrgent(task)) {
                return '<span class="badge bg-danger">عاجلة</span>';
            }
            return '<span class="badge bg-primary">معلقة</span>';
        }
        
        function getFilterText(filter) {
            return filter === 'pending' ? 'معلقة' : filter === 'completed' ? 'مكتملة' : '';
        }
        
        function updateActiveFilterButton(filter) {
            [showAllTasksBtn, showPendingTasksBtn, showCompletedTasksBtn].forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('btn-outline-primary');
            });
            
            if (filter === 'all') {
                showAllTasksBtn.classList.remove('btn-outline-primary');
                showAllTasksBtn.classList.add('btn-primary');
            } else if (filter === 'pending') {
                showPendingTasksBtn.classList.remove('btn-outline-primary');
                showPendingTasksBtn.classList.add('btn-primary');
            } else if (filter === 'completed') {
                showCompletedTasksBtn.classList.remove('btn-outline-primary');
                showCompletedTasksBtn.classList.add('btn-primary');
            }
        }
        
        function showAlert(message, type) {
            const alertId = `alert-${Date.now()}`;
            const alertElement = document.createElement('div');
            alertElement.id = alertId;
            alertElement.className = `alert alert-${type} alert-dismissible fade show`;
            alertElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.appendChild(alertElement);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.classList.add('fade');
                    setTimeout(() => alert.remove(), 150);
                }
            }, 5000);
        }
        
        function updateClassSelect(selectedDate) {
            const taskClassSelect = document.getElementById('task-class-select');
            taskClassSelect.innerHTML = '<option value="">اختر قسم</option>';
            
            if (!selectedDate) return;
            
            const day = getDayFromDate(selectedDate);
            const classes = schedule.filter(item => item.day === day);
            
            if (classes.length === 0) {
                taskClassSelect.innerHTML = '<option value="">لا توجد حصص في هذا اليوم</option>';
                return;
            }
            
            const uniqueClasses = [...new Set(classes.map(item => `${item.level} ${item.classNumber}`))];
            
            uniqueClasses.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                taskClassSelect.appendChild(option);
            });
        }
        
        function populateFieldSelect(level) {
            const taskFieldSelect = document.getElementById('task-field-select');
            taskFieldSelect.innerHTML = '<option value="">اختر ميدان</option>';
            
            if (!level || !curriculumData[level]) return;
            
            Object.keys(curriculumData[level]).forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                taskFieldSelect.appendChild(option);
            });
        }
        
        function populateModuleSelect(level, field) {
            const taskModuleSelect = document.getElementById('task-module-select');
            taskModuleSelect.innerHTML = '<option value="">اختر مقطع</option>';
            
            if (!level || !field || !curriculumData[level][field]) return;
            
            Object.keys(curriculumData[level][field]).forEach(module => {
                const option = document.createElement('option');
                option.value = module;
                option.textContent = module;
                taskModuleSelect.appendChild(option);
            });
        }
        
        function populateActivitySelect(level, field, module) {
            const taskActivitySelect = document.getElementById('task-activity-select');
            taskActivitySelect.innerHTML = '<option value="">اختر نشاط</option>';
            
            if (!level || !field || !module || !curriculumData[level][field][module]) return;
            
            curriculumData[level][field][module].forEach(activity => {
                const option = document.createElement('option');
                option.value = activity;
                option.textContent = activity;
                taskActivitySelect.appendChild(option);
            });
        }
        
        // Connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (!navigator.onLine) {
                statusElement.classList.remove('d-none');
            } else {
                statusElement.classList.add('d-none');
            }
        }
        
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();
